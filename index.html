<div id="admin-ui" class="admin-box hidden">
    <h3>Studio Manager (A/B Rotatie)</h3>
    <input type="text" id="track-search" placeholder="Zoek nummer of artiest..." style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: none; background: #333; color: white;">
    <div style="max-height: 500px; overflow-y: auto;">
        <table>
            <thead>
                <tr>
                    <th>Track</th>
                    <th>Artiest</th>
                    <th>A</th>
                    <th>B</th>
                </tr>
            </thead>
            <tbody id="track-table-body"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIGURATIE (Zorg dat je deze invult!) ---
    const CLIENT_ID = 'JOUW_CLIENT_ID'; 
    const PLAYLIST_ID = '8_JOUW_PLAYLIST_ID'; 
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    const firebaseConfig = {
        apiKey: "AIzaSyCw5AJyDYcqWxsYF5XDsu9FDnROTtkyWOE",
        authDomain: "koert-fm.firebaseapp.com",
        databaseURL: "https://koert-fm-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "koert-fm",
        appId: "1:944188148886:web:f76e33a9d8b6d4307bc6b7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let state = {
        token: null,
        player: null,
        deviceId: null,
        allTracks: [],
        rotationA: [],
        rotationB: [],
        history: [],
        counter: 0,
        jingleAudio: new Audio()
    };

    // --- SPOTIFY AUTH ---
    window.loginSpotify = () => {
        const scope = 'streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state';
        window.location.href = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scope)}`;
    };

    const checkToken = () => {
        const params = new URLSearchParams(window.location.hash.substring(1));
        state.token = params.get('access_token');
        if (state.token) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('player-ui').classList.remove('hidden');
            document.getElementById('admin-ui').classList.remove('hidden');
            initRadio();
        }
    };

    // --- RADIO ENGINE ---
    async function initRadio() {
        onValue(ref(db, 'rotations'), (snapshot) => {
            const val = snapshot.val() || {};
            state.rotationA = val.a || [];
            state.rotationB = val.b || [];
            if (state.allTracks.length === 0) fetchAllTracks();
            else renderAdmin();
        });
    }

    // Haal alle 1795 nummers op (Spotify limiet is 100 per keer)
    async function fetchAllTracks() {
        let url = `https://api.spotify.com/v1/playlists/${PLAYLIST_ID}/tracks?limit=100`;
        let tracks = [];
        
        document.getElementById('radio-status').innerText = 'STUDIO LADEN...';

        while (url) {
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${state.token}` } });
            const data = await res.json();
            tracks = tracks.concat(data.items.map(i => i.track).filter(t => t !== null));
            url = data.next; // Spotify geeft de link naar de volgende 100 nummers
        }

        state.allTracks = tracks;
        document.getElementById('radio-status').innerText = 'STAND-BY';
        renderAdmin();
    }

    // Zoekfunctie koppelen
    document.getElementById('track-search').addEventListener('input', (e) => {
        renderAdmin(e.target.value.toLowerCase());
    });

    function renderAdmin(filter = "") {
        const body = document.getElementById('track-table-body');
        const filtered = state.allTracks.filter(t => 
            t.name.toLowerCase().includes(filter) || 
            t.artists[0].name.toLowerCase().includes(filter)
        ).slice(0, 50); // Toon max 50 resultaten voor snelheid

        body.innerHTML = filtered.map(t => `
            <tr>
                <td>${t.name}</td>
                <td>${t.artists[0].name}</td>
                <td><input type="checkbox" ${state.rotationA.includes(t.id) ? 'checked' : ''} onchange="window.updateRot('${t.id}', 'A')"></td>
                <td><input type="checkbox" ${state.rotationB.includes(t.id) ? 'checked' : ''} onchange="window.updateRot('${t.id}', 'B')"></td>
            </tr>
        `).join('');
    }

    window.updateRot = (id, type) => {
        let list = type === 'A' ? [...state.rotationA] : [...state.rotationB];
        if (list.includes(id)) {
            list = list.filter(i => i !== id);
        } else {
            if (list.length >= 5) list.shift();
            list.push(id);
        }
        set(ref(db, `rotations/${type.toLowerCase()}`), list);
    };

    // --- PLAYER LOGICA ---
    window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
            name: 'Koert.fm Studio Player',
            getOAuthToken: cb => { cb(state.token); }
        });

        player.addListener('ready', ({ device_id }) => {
            state.deviceId = device_id;
            const btn = document.getElementById('play-btn');
            btn.innerText = 'START UITZENDING';
            btn.onclick = () => startRadio();
        });

        player.connect();
        state.player = player;
    };

    async function startRadio() {
        document.getElementById('play-btn').classList.add('hidden');
        document.getElementById('radio-status').innerText = 'ON AIR';
        playNext();
    }

    function playNext() {
        state.counter++;
        
        if (state.counter % 5 === 0) {
            playJingle();
            return;
        }

        let pool = state.allTracks;
        // Rotatie A: elke 30 nummers een blokje van 5 uit A
        if (state.counter % 30 >= 1 && state.counter % 30 <= 5 && state.rotationA.length > 0) {
            pool = state.allTracks.filter(t => state.rotationA.includes(t.id));
        } 
        // Rotatie B: nummer 1 van elke 100
        else if (state.counter % 100 === 1 && state.rotationB.length > 0) {
            pool = state.allTracks.filter(t => state.rotationB.includes(t.id));
        }

        // Artist Separation (Blokkeer artiesten uit de laatste 10 nummers)
        let valid = pool.filter(t => !state.history.includes(t.artists[0].id));
        if (valid.length === 0) valid = pool; // Fallback als de pool leeg dreigt te raken

        const track = valid[Math.floor(Math.random() * valid.length)];

        state.history.push(track.artists[0].id);
        if (state.history.length > 10) state.history.shift();

        playSpotify(track);
    }

    async function playSpotify(track) {
        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${state.deviceId}`, {
            method: 'PUT',
            body: JSON.stringify({ uris: [track.uri] }),
            headers: { 'Authorization': `Bearer ${state.token}` }
        });
        
        document.getElementById('track-title').innerText = track.name;
        document.getElementById('track-artist').innerText = track.artists[0].name;
        document.getElementById('album-art').src = track.album.images[0].url;

        // Start de monitoring om te zien wanneer het nummer eindigt
        setTimeout(() => checkFinished(), 10000);
    }

    function playJingle() {
        const jingleUrls = ['https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3']; 
        state.jingleAudio.src = jingleUrls[0];
        document.getElementById('track-title').innerText = "⚡ JINGLE ⚡";
        document.getElementById('radio-status').innerText = 'JINGLE';
        state.jingleAudio.play();
        state.jingleAudio.onended = () => {
            document.getElementById('radio-status').innerText = 'ON AIR';
            playNext();
        };
    }

    function checkFinished() {
        state.player.getCurrentState().then(s => {
            // Als het nummer gestopt is en we staan op 0, laad de volgende
            if (s && s.paused && s.position === 0) {
                playNext();
            } else {
                setTimeout(() => checkFinished(), 3000);
            }
        });
    }

    checkToken();
</script>
